import { addHelpers } from './helpers.js';
import { createServer } from 'http';
import { serializeBody } from '../utils.js';
import { streamToBuffer } from '@vercel/build-utils';
import exitHook from 'exit-hook';
import fetch from 'node-fetch';
import { listen } from 'async-listen';
import { isAbsolute } from 'path';
import { pathToFileURL } from 'url';
const [NODE_MAJOR] = process.versions.node.split('.').map(v => Number(v));
/* https://nextjs.org/docs/app/building-your-application/routing/router-handlers#supported-http-methods */
const HTTP_METHODS = [
    'GET',
    'HEAD',
    'OPTIONS',
    'POST',
    'PUT',
    'DELETE',
    'PATCH',
];
async function createServerlessServer(userCode) {
    const server = createServer(userCode);
    exitHook(() => server.close());
    return { url: await listen(server) };
}
async function compileUserCode(entrypointPath, options) {
    const id = isAbsolute(entrypointPath)
        ? pathToFileURL(entrypointPath).href
        : entrypointPath;
    let listener = await import(id);
    /**
     * In some cases we might have nested default props due to TS => JS
     */
    for (let i = 0; i < 5; i++) {
        if (listener.default)
            listener = listener.default;
    }
    if (HTTP_METHODS.some(method => typeof listener[method] === 'function')) {
        if (NODE_MAJOR < 18) {
            throw new Error('Node.js v18 or above is required to use HTTP method exports in your functions.');
        }
        const { getWebExportsHandler } = await import('./helpers-web.js');
        return getWebExportsHandler(listener, HTTP_METHODS);
    }
    return async (req, res) => {
        if (options.shouldAddHelpers)
            await addHelpers(req, res);
        return listener(req, res);
    };
}
export async function createServerlessEventHandler(entrypointPath, options) {
    const userCode = await compileUserCode(entrypointPath, options);
    const server = await createServerlessServer(userCode);
    return async function (request) {
        const url = new URL(request.url ?? '/', server.url);
        // @ts-expect-error
        const response = await fetch(url, {
            body: await serializeBody(request),
            headers: {
                ...request.headers,
                host: request.headers['x-forwarded-host'],
            },
            method: request.method,
            redirect: 'manual',
        });
        let body;
        if (options.mode === 'streaming') {
            body = response.body;
        }
        else {
            body = await streamToBuffer(response.body);
            response.headers.delete('transfer-encoding');
            response.headers.set('content-length', body.length);
        }
        return {
            status: response.status,
            headers: response.headers,
            body,
            encoding: 'utf8',
        };
    };
}
