{"version":3,"file":"edge-vm.js","sourceRoot":"","sources":["../src/edge-vm.ts"],"names":[],"mappings":"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","sourcesContent":["import type * as EdgePrimitives from '@edge-runtime/primitives'\nimport type { VMContext, VMOptions } from './vm'\nimport { Buffer } from 'buffer'\nimport { requireWithCache } from './require'\nimport { VM } from './vm'\nimport { runInContext } from 'vm'\n\nexport interface EdgeVMOptions<T> {\n  /**\n   * Provide code generation options to the Node.js VM.\n   * If you don't provide any option, code generation will be disabled.\n   */\n  codeGeneration?: VMOptions<T>['codeGeneration']\n  /**\n   * Allows to extend the VMContext. Note that it must return a contextified\n   * object so ideally it should return the same reference it receives.\n   */\n  extend?: (context: EdgeContext) => EdgeContext & T\n  /**\n   * Provides an initial map to the require cache.\n   * If none is given, it will be initialized to an empty map.\n   */\n  requireCache?: VMOptions<T>['requireCache']\n}\n\n/**\n * An implementation of a VM that pre-loads on its context Edge Primitives.\n * The context can be extended from its constructor.\n */\nexport class EdgeVM<T extends EdgeContext> extends VM<T> {\n  constructor(options: EdgeVMOptions<T> = {}) {\n    super({\n      ...options,\n      extend: (context) => {\n        return options.extend\n          ? options.extend(addPrimitives(context))\n          : (addPrimitives(context) as EdgeContext & T)\n      },\n    })\n  }\n}\n\nexport type EdgeContext = VMContext & {\n  self: EdgeContext\n  globalThis: EdgeContext\n  AbortController: typeof EdgePrimitives.AbortController\n  AbortSignal: typeof EdgePrimitives.AbortSignal\n  atob: typeof EdgePrimitives.atob\n  Blob: typeof EdgePrimitives.Blob\n  btoa: typeof EdgePrimitives.btoa\n  Cache: typeof EdgePrimitives.Cache\n  caches: typeof EdgePrimitives.caches\n  CacheStorage: typeof EdgePrimitives.CacheStorage\n  console: typeof EdgePrimitives.console\n  createCaches: typeof EdgePrimitives.createCaches\n  crypto: typeof EdgePrimitives.crypto\n  Crypto: typeof EdgePrimitives.Crypto\n  CryptoKey: typeof EdgePrimitives.CryptoKey\n  DOMException: typeof EdgePrimitives.DOMException\n  Event: typeof EdgePrimitives.Event\n  EventTarget: typeof EdgePrimitives.EventTarget\n  fetch: typeof EdgePrimitives.fetch\n  FetchEvent: typeof EdgePrimitives.FetchEvent\n  File: typeof EdgePrimitives.File\n  FormData: typeof EdgePrimitives.FormData\n  Headers: typeof EdgePrimitives.Headers\n  PromiseRejectionEvent: typeof EdgePrimitives.PromiseRejectionEvent\n  ReadableStream: typeof EdgePrimitives.ReadableStream\n  ReadableStreamBYOBReader: typeof EdgePrimitives.ReadableStreamBYOBReader\n  ReadableStreamDefaultReader: typeof EdgePrimitives.ReadableStreamDefaultReader\n  Request: typeof EdgePrimitives.Request\n  Response: typeof EdgePrimitives.Response\n  structuredClone: typeof EdgePrimitives.structuredClone\n  SubtleCrypto: typeof EdgePrimitives.SubtleCrypto\n  TextDecoder: typeof EdgePrimitives.TextDecoder\n  TextEncoder: typeof EdgePrimitives.TextEncoder\n  TransformStream: typeof EdgePrimitives.TransformStream\n  URL: typeof EdgePrimitives.URL\n  URLPattern: typeof EdgePrimitives.URLPattern\n  URLSearchParams: typeof EdgePrimitives.URLSearchParams\n  WritableStream: typeof EdgePrimitives.WritableStream\n  WritableStreamDefaultWriter: typeof EdgePrimitives.WritableStreamDefaultWriter\n  EdgeRuntime: string\n}\n\nfunction addPrimitives(context: VMContext) {\n  defineProperty(context, 'self', { enumerable: true, value: context })\n  defineProperty(context, 'globalThis', { value: context })\n  defineProperty(context, 'Symbol', { value: Symbol })\n  defineProperty(context, 'clearInterval', { value: clearInterval })\n  defineProperty(context, 'clearTimeout', { value: clearTimeout })\n  defineProperty(context, 'setInterval', { value: setInterval })\n  defineProperty(context, 'setTimeout', { value: setTimeout })\n  defineProperty(context, 'EdgeRuntime', { value: 'edge-runtime' })\n\n  // Console\n  defineProperties(context, {\n    exports: requireWithCache({\n      context,\n      path: require.resolve('@edge-runtime/primitives/console'),\n      scopedContext: { console },\n    }),\n    nonenumerable: ['console'],\n  })\n\n  const encodings = requireWithCache({\n    context,\n    path: require.resolve('@edge-runtime/primitives/encoding'),\n    scopedContext: { Buffer, global: {} },\n  })\n\n  // Encoding APIs\n  defineProperties(context, {\n    exports: encodings,\n    nonenumerable: ['atob', 'btoa', 'TextEncoder', 'TextDecoder'],\n  })\n\n  const streams = requireWithCache({\n    path: require.resolve('@edge-runtime/primitives/streams'),\n    context,\n  })\n\n  // Streams\n  defineProperties(context, {\n    exports: streams,\n    nonenumerable: [\n      'ReadableStream',\n      'ReadableStreamBYOBReader',\n      'ReadableStreamDefaultReader',\n      'TransformStream',\n      'WritableStream',\n      'WritableStreamDefaultWriter',\n    ],\n  })\n\n  const abort = requireWithCache({\n    context,\n    path: require.resolve('@edge-runtime/primitives/abort-controller'),\n  })\n\n  // AbortController\n  defineProperties(context, {\n    exports: abort,\n    nonenumerable: ['AbortController', 'AbortSignal', 'DOMException'],\n  })\n\n  // URL\n  defineProperties(context, {\n    exports: requireWithCache({\n      cache: new Map([['punycode', { exports: require('punycode') }]]),\n      context,\n      path: require.resolve('@edge-runtime/primitives/url'),\n      scopedContext: {\n        TextEncoder: encodings.TextEncoder,\n        TextDecoder: encodings.TextDecoder,\n      },\n    }),\n    nonenumerable: ['URL', 'URLSearchParams', 'URLPattern'],\n  })\n\n  const blob = requireWithCache({\n    context,\n    path: require.resolve('@edge-runtime/primitives/blob'),\n  })\n\n  // Blob\n  defineProperties(context, {\n    exports: blob,\n    nonenumerable: ['Blob'],\n  })\n\n  const webFetch = requireWithCache({\n    context,\n    cache: new Map([\n      ['abort-controller', { exports: abort }],\n      ['assert', { exports: require('assert') }],\n      ['buffer', { exports: require('buffer') }],\n      ['events', { exports: require('events') }],\n      ['http', { exports: require('http') }],\n      ['net', { exports: require('net') }],\n      ['perf_hooks', { exports: require('perf_hooks') }],\n      ['querystring', { exports: require('querystring') }],\n      ['stream', { exports: require('stream') }],\n      ['tls', { exports: require('tls') }],\n      ['util', { exports: require('util') }],\n      ['zlib', { exports: require('zlib') }],\n      [\n        require.resolve('@edge-runtime/primitives/streams'),\n        { exports: streams },\n      ],\n      [require.resolve('@edge-runtime/primitives/blob'), { exports: blob }],\n    ]),\n    path: require.resolve('@edge-runtime/primitives/fetch'),\n    scopedContext: {\n      Uint8Array: createUint8ArrayForContext(context),\n      Buffer,\n      global: {},\n      queueMicrotask,\n      setImmediate,\n      clearImmediate,\n    },\n  })\n\n  // Fetch APIs\n  defineProperties(context, {\n    exports: webFetch,\n    nonenumerable: [\n      'fetch',\n      'File',\n      'FormData',\n      'Headers',\n      'Request',\n      'Response',\n    ],\n  })\n\n  // Cache\n  defineProperties(context, {\n    exports: requireWithCache({\n      cache: new Map([\n        [\n          require.resolve('@edge-runtime/primitives/fetch'),\n          { exports: webFetch },\n        ],\n      ]),\n      context,\n      path: require.resolve('@edge-runtime/primitives/cache'),\n      scopedContext: { global: {} },\n    }),\n    enumerable: ['caches'],\n    nonenumerable: ['Cache', 'CacheStorage'],\n  })\n\n  // Crypto\n  defineProperties(context, {\n    exports: requireWithCache({\n      context,\n      cache: new Map([\n        ['crypto', { exports: require('crypto') }],\n        ['process', { exports: require('process') }],\n      ]),\n      path: require.resolve('@edge-runtime/primitives/crypto'),\n      scopedContext: {\n        Buffer,\n        Uint8Array: createUint8ArrayForContext(context),\n      },\n    }),\n    enumerable: ['crypto'],\n    nonenumerable: ['Crypto', 'CryptoKey', 'SubtleCrypto'],\n  })\n\n  // Events\n  defineProperties(context, {\n    exports: requireWithCache({\n      context,\n      path: require.resolve('@edge-runtime/primitives/events'),\n    }),\n    nonenumerable: [\n      'Event',\n      'EventTarget',\n      'FetchEvent',\n      'PromiseRejectionEvent',\n    ],\n  })\n\n  // Structured Clone\n  defineProperties(context, {\n    exports: requireWithCache({\n      context,\n      path: require.resolve('@edge-runtime/primitives/structured-clone'),\n    }),\n    nonenumerable: ['structuredClone'],\n  })\n\n  return context as EdgeContext\n}\n\nfunction defineProperty(obj: any, prop: string, attrs: PropertyDescriptor) {\n  Object.defineProperty(obj, prop, {\n    configurable: attrs.configurable ?? false,\n    enumerable: attrs.enumerable ?? false,\n    value: attrs.value,\n    writable: attrs.writable ?? true,\n  })\n}\n\nfunction defineProperties(\n  context: any,\n  options: {\n    exports: Record<string, any>\n    enumerable?: string[]\n    nonenumerable?: string[]\n  }\n) {\n  for (const property of options.enumerable ?? []) {\n    if (!options.exports[property]) {\n      throw new Error(`Attempt to export a nullable value for \"${property}\"`)\n    }\n\n    defineProperty(context, property, {\n      enumerable: true,\n      value: options.exports[property],\n    })\n  }\n\n  for (const property of options.nonenumerable ?? []) {\n    if (!options.exports[property]) {\n      throw new Error(`Attempt to export a nullable value for \"${property}\"`)\n    }\n\n    defineProperty(context, property, {\n      value: options.exports[property],\n    })\n  }\n}\n\nfunction createUint8ArrayForContext(context: VMContext) {\n  return new Proxy(runInContext('Uint8Array', context), {\n    // on every construction (new Uint8Array(...))\n    construct(target, args) {\n      // construct it\n      const value: Uint8Array = new target(...args)\n\n      // if this is not a buffer\n      if (!(args[0] instanceof Buffer)) {\n        // return what we just constructed\n        return value\n      }\n\n      // if it is a buffer, then we spread the binary data into an array,\n      // and build the Uint8Array from that\n      return new target([...value])\n    },\n  })\n}\n"]}